{% extends "base.html" %}
{% load static %}
{% block content %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=b53d3e95e27811083b5ac0f850526bb3"></script>
<meta name='csrf_token' content='{{csrf_token}}'>
{% block body_class %}{% endblock %}

<article>
  <div class='view_wrap'>

    <div class='view_header'>
      <h2 class='subject'>{{data.title}}</h2>
      <div class='location'>
        <ul class='list'>
          <li>
            <strong class='title'>주소 | </strong>
            <sapn class='text'>{{data.address}}</sapn>
          </li>
          <li>
            <strong class='title'>전화번호</strong>
            <sapn class='text'>{{data.tel}}</sapn>
          </li>
        </ul>
      </div>
    </div>

    <div class='info'>
      {% if user.is_authenticated %}
        {% if like %}
        <button class="like-button" data-liked="true" data-post-id="{{ data.place_id }}">좋아요 취소</button>
        {% else %}
        <button class="like-button" data-liked="false" data-post-id="{{ data.place_id }}">좋아요</button>
        {% endif %}
      {% else %}
        <button class='not_login'>좋아요</button>
      {% endif %}
      <span id='like-count'>{{ data.like_count }}명이 좋아요를 눌렀습니다.</span>
      <span>조회 {{view_count}}</span>
      <span>등록일 | {{data.created_at}}</span>
      <span>수정일 | {{data.updated_at}}</span>
    </div>

    <div class='view_photos'>
      {% if data.image != '' %}
      <div><img src="{{data.image}}"></div>
      {% else %}
      <div><img src="{% static "images/no-image.jpg" %}"></div>
      {% endif %}
    </div>

    <div class='view_tap'>
      <a href="#intro" class='link active'>
        <span>소개</span>
      </a>
      <a href="#guide" class='link'>
        <span>이용정보</span>
      </a>
      <a href="#tour_list" class='link'>
        <span>주변관광지</span>
      </a>
    </div>

    <div id='intro'>
      <div class='cont_wrap'>
        <p>{{data.overview}}</p>
      </div>
    </div>

    <div id='guide' class='section'>
      <h3>이용정보</h3>
      <table class='table'>
        <colgroup>
          <col style='width: 230px;'>
          <col>
        </colgroup>
        <tbody>
          {% for label, value in display_fields %}
            <tr>
                <th scope='row'>{{ label }}</th>
                <td>{{ value }}</td>
            </tr>
          {% empty %}
              <tr><td colspan="2">데이터가 없습니다.</td></tr>
          {% endfor %}
      </tbody>
      </table>
    </div>

    <div id='tour_list' class='section'>
      <h3>주변 관광지</h3>
      <div class='map_wrap'>
        <div id='map' class='map'></div>
          <script>
            var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
              mapOption = { 
                center: new kakao.maps.LatLng({{data.map_y}}, {{data.map_x}} + 0.004), // 지도의 중심좌표
                level: 4 // 지도의 확대 레벨
            };

            var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

            var positions = [
            {% for around_data in around %}
              {
                content: '<div>{{around_data.title}}</div>', 
                latlng: new kakao.maps.LatLng({{around_data.map_y}}, {{around_data.map_x}})
              },
            {% endfor %}
            ];
            for (var i = 0; i < positions.length; i ++) {
              // 마커를 생성합니다
              var marker = new kakao.maps.Marker({
                  map: map, // 마커를 표시할 지도
                  position: positions[i].latlng // 마커의 위치
              });
          
              // 마커에 표시할 인포윈도우를 생성합니다 
              var infowindow = new kakao.maps.InfoWindow({
                  content: positions[i].content // 인포윈도우에 표시할 내용
              });
          
              // 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
              // 이벤트 리스너로는 클로저를 만들어 등록합니다 
              // for문에서 클로저를 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
              kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
              kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));
              }

              // 인포윈도우를 표시하는 클로저를 만드는 함수입니다 
              function makeOverListener(map, marker, infowindow) {
                  return function() {
                      infowindow.open(map, marker);
                  };
              }
              
              // 인포윈도우를 닫는 클로저를 만드는 함수입니다 
              function makeOutListener(infowindow) {
                  return function() {
                      infowindow.close();
                  };
              }

              // main_content marker start
              var markerPosition  = new kakao.maps.LatLng({{data.map_y}}, {{data.map_x}}); 

              var marker = new kakao.maps.Marker({
                position: markerPosition
              });

              marker.setMap(map);

              var iwContent = '<div style="padding:5px;">{{data.title}}</div>', // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
              iwPosition = new kakao.maps.LatLng({{data.map_y}}, {{data.map_x}});

              var infowindow = new kakao.maps.InfoWindow({
                position : iwPosition, 
                content : iwContent 
              });
              infowindow.open(map, marker);
              // main_content marker end

              marker.setMap(map);
          </script>

          <script src="{% static 'js/view.js' %}"></script>
        <div class='near_map'>
          <div class='near_tap'></div>
            <div id='tap1'>
              <ul>
                {% if len != 1 %}
                  {% for aro in around %}
                    {% if data.title != aro.title %}
                      <li class='item'>
                        <div class='near_photo'>
                          {% if aro.thumb_img != '' %}
                          <img src="{{aro.thumb_img}}">
                          {% else %}
                          <img src="{% static "images/no-image.jpg" %}">
                          {% endif %}
                        </div>
                        <div class='cont'>
                          <div class='near_subject'>{{aro.title}}</div>
                          <div class='near_tel'>{{aro.tel}}</div>
                          <div class='near_address'>{{aro.address}}</div>
                          <a href='/place/local/{{aro.sigungu_code.area_code.area_code}}/view/{{aro.place_id}}' class='near_more'>자세히 보기</a>
                        </div>
                      </li>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <li class='item'>
                    <div class='cont'>
                    인근 관광지가 없습니다.
                    </div>
                  </li>
                {% endif %}
              </ul>
            </div>
        </div>  <!-- //near_map -->
      </div>
    </div>

  </div>  <!-- //view_wrap -->

</article>
<script>
  document.querySelectorAll('.like-button').forEach(button => {
    button.addEventListener('click', function () {
        const postId = this.getAttribute('data-post-id');
        const isLiked = this.getAttribute('data-liked') === 'true';

        // 버튼 클릭 시 비활성화 (중복 클릭 방지)
        this.disabled = true;

        fetch(`/place/like/${postId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken = $('meta[name=csrf_token]').attr('content'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ liked: !isLiked })
        })
        .then(response => response.json())
        .then(data => {
            this.textContent = data.liked ? '좋아요 취소' : '좋아요';
            this.setAttribute('data-liked', data.liked);
            document.querySelector(`#like-count`).textContent = `${data.like_count}명이 좋아요를 눌렀습니다.`;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('좋아요 처리 중 오류가 발생했습니다.');
        })
        .finally(() => {
            // 버튼 클릭 후 비활성화 해제
            this.disabled = false;
        });
    });
  });
  $('.not_login').click(function(){
    alert('좋아요는 로그인을 하셔야 합니다.')
  })
</script>

{% endblock content %}  